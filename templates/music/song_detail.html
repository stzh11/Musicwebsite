
{% load static %}
{% block title %}{{ song.title }}{% endblock title %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 py-8">
  {# ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî –û—Å–Ω–æ–≤–Ω–æ–π –±–ª–æ–∫ –ø–µ—Å–Ω–∏ ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî #}
  <div class="flex flex-col md:flex-row items-start md:items-center mb-8">
    {% if song.cover.url %}
      <img src="{{ song.cover.url }}" alt="{{ song.title }}" class="w-full md:w-48 h-48 object-cover rounded-lg shadow mr-6 mb-4 md:mb-0">
    {% endif %}
    <div>
      <h1 class="text-4xl font-bold mb-2">{{ song.title }}</h1>
      {% if song.album %}
        <p class="text-lg text-gray-600 mb-1">–ê–ª—å–±–æ–º: <a href="{{ song.album.get_absolute_url }}" class="text-blue-500 hover:underline">{{ song.album.title }}</a></p>
      {% endif %}
      {% if song.released_date %}
        <p class="text-sm text-gray-500">–î–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞: {{ song.released_date|date:"d.m.Y" }}</p>
      {% endif %}
      <form action="{% url 'song-like-toggle' song.slug %}"
        method="post" style="display:inline">
          {% csrf_token %}
          {% if user.is_authenticated %}
            {% if user.id in likes.users %}
              <button type="submit" class="text-red-500 hover:text-red-700">
                ‚ù§Ô∏è –û—Ç–º–µ–Ω–∏—Ç—å –ª–∞–π–∫
              </button>
            {% else %}
              <button type="submit" class="text-gray-500 hover:text-gray-700">
                ü§ç –ü–æ—Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫
              </button>
            {% endif %}
          {% else %}
            <a href="{% url 'login' %}">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ª–∞–π–∫–∞—Ç—å</a>
          {% endif %}
      </form>
      <p>–õ–∞–π–∫–æ–≤: {{ song.likes.count }}</p>
    </div>
  </div>
  {# —Å–ø–∏—Å–æ–∫ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ #}
<section class="mt-8">
  <h2 class="text-xl font-semibold mb-4">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h2>

  {% if song.comments.all %}
    <ul class="space-y-4">
      {% for c in song.comments.all %}
        <li class="border-b pb-2">
          <p class="text-sm text-gray-600">
            {{ c.author.username }} ¬∑ {{ c.created_at|date:"d.m.Y H:i" }}
          </p>
          <p>{{ c.text }}</p>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="text-gray-500">–ü–æ–∫–∞ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è.</p>
  {% endif %}
</section>

{# —Ñ–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è #}
<section class="mt-6">
  {% if user.is_authenticated %}
    <form action="{% url 'comments:song-add-comment' song.slug %}"
          method="post" class="space-y-2">
      {% csrf_token %}
      {{ form.text }}
      <button type="submit"
              class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded">
        –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
      </button>
    </form>
  {% else %}
    <p>
      <a href="{% url 'login' %}" class="text-blue-600 hover:underline">
        –í–æ–π–¥–∏—Ç–µ
      </a>, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.
    </p>
  {% endif %}
</section>

  {# ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî –û–ø–∏—Å–∞–Ω–∏–µ ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî #}
  {% if song.description %}
    <section class="mb-8">
      <h2 class="text-2xl font-semibold mb-2">–û–ø–∏—Å–∞–Ω–∏–µ</h2>
      <p class="text-gray-800">{{ song.description }}</p>
    </section>
  {% endif %}

  {# ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî –¢–µ–∫—Å—Ç—ã ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî #}

{# 1. –†–∞–∑–º–µ—Ç–∫–∞ —Å–∞–º–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, –≥–¥–µ –º–æ–∂–Ω–æ –≤—ã–¥–µ–ª—è—Ç—å #}
 <section id="lyrics" class="prose mb-8">
  {{ highlighted_lyrics|safe }}
</section>

<style>
  .annotation { background: yellow !important; }
  /* –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ Tailwind –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω */
  .hidden { display: none !important; }
</style>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–æ -->
<div id="annotation-modal"
     hidden
     class="fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white p-6 rounded shadow-lg w-full max-w-md max-h-[90vh] overflow-auto">
    {% include "music/annotation_form.html" with form=annotation_form song=song %}
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const lyricsEl = document.getElementById("lyrics");
  const modal    = document.getElementById("annotation-modal");
  const form     = document.getElementById("annotation-form");
  const cancel   = document.getElementById("cancel");
  let start, end;

  lyricsEl.addEventListener("mouseup", () => {
    const sel = window.getSelection();
    if (!sel.rangeCount || !sel.toString().trim()) return;
    const range = sel.getRangeAt(0);
    start = range.startOffset;
    end   = range.endOffset;
    modal.hidden = false;
  });

  form.addEventListener("submit", ev => {
    ev.preventDefault();
    form.querySelector('input[name="start_idx"]').value = start;
    form.querySelector('input[name="end_idx"]').value   = end;
    form.submit();
  });

  cancel.addEventListener("click", () => {
    modal.hidden = true;
  });
});
</script>



{# ‚Ä¶ –¥–∞–ª—å—à–µ –≤–∞—à —à–∞–±–ª–æ–Ω ‚Ä¶ #}



  {# ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî –í–∏–¥–µ–æ ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî #}
  {% if song.clip_url %}
    <section class="mb-8">
      <h2 class="text-2xl font-semibold mb-2">–í–∏–¥–µ–æ</h2>
      <div class="aspect-w-16 aspect-h-9">
        <iframe src="{{ song.clip_url }}" allowfullscreen class="w-full h-full rounded"></iframe>
      </div>
    </section>
  {% endif %}

  {# ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî –°–ª—É—à–∞—Ç—å –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–ú—É–∑—ã–∫–µ ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî #}
  {% if song.yandex_music_url %}
    <section class="mb-8">
      <a href="{{ song.yandex_music_url }}" target="_blank" class="inline-block bg-yellow-500 hover:bg-yellow-600 text-white font-medium px-4 py-2 rounded">–°–ª—É—à–∞—Ç—å –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–ú—É–∑—ã–∫–µ</a>
    </section>
  {% endif %}

  {# ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî –£—á–∞—Å—Ç–Ω–∏–∫–∏ ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî #}
  <section class="mb-8">
    <h2 class="text-2xl font-semibold mb-2">–£—á–∞—Å—Ç–Ω–∏–∫–∏</h2>
    <ul class="list-disc list-inside space-y-2">
      {% for conn in conns %}
        <li>
          <a href="{{ conn.artist.get_absolute_url }}" class="font-medium text-blue-500 hover:underline">{{ conn.artist.name }}</a> ‚Äî {{ conn.get_role_display }}
        </li>
      {% empty %}
        <li class="text-gray-500">–£ —ç—Ç–æ–π –ø–µ—Å–Ω–∏ –µ—â—ë –Ω–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.</li>
      {% endfor %}
    </ul>
  </section>
  <section class="mb-8">
    <h2 class="text-2xl font-semibold mb-2">–ñ–∞–Ω—Ä—ã</h2>
    <ul class="list-disc list-inside space-y-2">
      {% for genre in genres %}
        <li>
          <a>{{ genre.genre }}</a> 
        </li>
      {% empty %}
        <li class="text-gray-500">–£ —ç—Ç–æ–π –ø–µ—Å–Ω–∏ –µ—â—ë –Ω–µ—Ç –∂–∞–Ω—Ä–∞.</li>
      {% endfor %}
    </ul>
  </section>
  <a href="{% url 'song-create' %}"
   class="inline-block bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded">
  –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Å–Ω—é
  </a>
</div>
{% endblock content %}

